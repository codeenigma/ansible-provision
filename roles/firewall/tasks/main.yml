---

- name: Install UFW
  apt:
    pkg: ["ufw"]
    state: present
    update_cache: yes
    cache_valid_time: 240

- name: Replace Default UFW Config
  template:
    src: ufw.j2
    dest: /etc/default/ufw
    owner: root
    group: root
    mode: 0644
  notify: reset firewall

- name: Gather facts from the controller/provisioner.
  setup:
  delegate_to: "localhost"
  delegate_facts: yes

- name: Gather facts from the utility server.
  setup:
  delegate_to: "{{ user_deploy.utility_host }}"
  delegate_facts: yes
  when: 
    - user_deploy is defined
    - user_deploy.utility_host is defined
    - not user_deploy.utility_host == 'localhost'

- name: Gather allowed SSH hosts from inventory (IPV4).
  set_fact:
    _firewall_allow_ssh_ipv4: "{{ hostvars['localhost']['ansible_all_ipv4_addresses'] + ansible_all_ipv4_addresses }}"

- name: Gather allowed SSH hosts from inventory (IPV6).
  set_fact:
    _firewall_allow_ssh_ipv6: "{{ hostvars['localhost']['ansible_all_ipv6_addresses'] + ansible_all_ipv6_addresses }}"

- name: Gather allowed SSH hosts from utility server (IPV4).
  set_fact:
    _firewall_allow_ssh_ipv4: "{{ _firewall_allow_ssh_ipv4 + hostvars[user_deploy.utility_host]['ansible_all_ipv4_addresses'] }}"
  when: 
    - user_deploy is defined
    - user_deploy.utility_host is defined
    - not user_deploy.utility_host == 'localhost'

- name: Gather allowed SSH hosts from utility server (IPV6).
  set_fact:
    _firewall_allow_ssh_ipv6: "{{ _firewall_allow_ssh_ipv6 + hostvars[user_deploy.utility_host]['ansible_all_ipv6_addresses'] }}"
  when: 
    - user_deploy is defined
    - user_deploy.utility_host is defined
    - not user_deploy.utility_host == 'localhost'

- name: Gather allowed SSH hosts from utility domain name (IPV4).
  set_fact:
    _firewall_allow_ssh_ipv4: "{{ _firewall_allow_ssh_ipv4 + lookup('dig', user_deploy.utility_host, 'qtype=A', wantlist=True) }}"
  when: 
    - user_deploy is defined
    - user_deploy.utility_host is defined
    - not user_deploy.utility_host == 'localhost'

- name: Gather allowed SSH hosts from utility domain name (IPV6).
  set_fact:
    _firewall_allow_ssh_ipv6: "{{ _firewall_allow_ssh_ipv6 + lookup('dig', user_deploy.utility_host, 'qtype=AAAA', wantlist=True) }}"
  when: 
    - user_deploy is defined
    - user_deploy.utility_host is defined
    - not user_deploy.utility_host == 'localhost'

- name: Add a rule to allow SSH from known hosts (IPV4).
  ufw:
    from_ip: "{{ ip }}"
    to_port: "22"
    rule: allow
    proto: tcp
    comment: Allow SSH from associated servers.
  with_items: "{{ _firewall_allow_ssh_ipv4 }}"
  loop_control:
    loop_var: ip

- name: Add a rule to allow SSH from known hosts (IPV6).
  ufw:
    from_ip: "{{ ip }}"
    to_port: "22"
    rule: allow
    proto: tcp
    comment: Allow SSH from associated servers.
  with_items: "{{ _firewall_allow_ssh_ipv6 }}"
  loop_control:
    loop_var: ip
  when: firewall.ipv6

- name: Define inbound IPs
  set_fact:
    _firewall_inbound: "{{ firewall.inbound + firewall._inbound_defaults }}"

- name: Define outbound IPs
  set_fact:
    _firewall_outbound: "{{ firewall.outbound + firewall._outbound_defaults }}"

- name: Allow firewall inbound rules
  include_tasks: inbound.yml
  with_items: "{{ _firewall_inbound }}"
  loop_control:
    loop_var: inbound    

- name: Allow firewall outbound rules
  include_tasks: outbound.yml
  with_items: "{{ _firewall_outbound }}"
  loop_control:
    loop_var: outbound
    
- name: Configure Additional Firewall Rules

  # https://docs.ansible.com/ansible/latest/modules/ufw_module.html#parameters

  ufw:
    comment: "{{ item.comment | default(omit) }}"
    delete: "{{ item.delete | default(omit) }}"
    direction: "{{ item.direction | default(omit) }}"
    from_ip: "{{ item.from_ip | default(omit) }}"
    from_port: "{{ item.from_port | default(omit) }}"
    insert: "{{ item.insert | default(omit) }}"
    interface: "{{ item.interface | default(omit) }}"
    log: "{{ item.log | default(omit) }}"
    logging: "{{ item.logging | default(omit) }}"
    name: "{{ item.name | default(omit) }}"
    policy: "{{ item.policy | default(omit) }}"
    port: "{{ item.port | default(omit) }}"
    proto: "{{ item.proto | default(omit) }}"
    rule: "{{ item.rule | default('allow') }}"
    state: "{{ item.state | default(omit) }}"
    to_ip: "{{ item.to_ip | default(omit) }}"
    to_port: "{{ item.to_port | default(omit) }}"
    route: "{{ item.route | default(omit) }}"
  with_items: "{{ firewall.rules }}"

- name: Reload UFW Config
  template:
    src: ufw.j2
    dest: /etc/default/ufw
    owner: root
    group: root
    mode: 0644
  notify: reload firewall
